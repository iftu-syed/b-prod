
 <!--this the code that display the all the dynamic graphs-->


 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Details</title>
    <link rel="stylesheet" href="/style.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        body {
            overflow: hidden;
        }
        .container {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: flex-start;
            align-items: flex-start;
            gap: 20px;
            padding: 20px;
            overflow: auto; /* Ensure the container itself can scroll if needed */
        }
        .profile-card {
            max-width: 300px;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .form-container {
            flex-grow: 1;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow: auto; /* Allow the form container to scroll */
            max-height: 80vh; /* Prevents the form container from overflowing the viewport */
        }
        .survey-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .survey-button {
            padding: 10px;
            background-color: #28a745;
            color: #ffffff;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            text-align: center;
        }
        .survey-button:hover {
            background-color: #218838;
        }
        .highlight {
            font-weight: bold;
            color: #007bff;
        }
        .note-form, .code-form {
            display: flex;
            flex-direction: row;
            align-items: center;
            margin-bottom: 20px;
        }
        .note-form label, .code-form label {
            margin-right: 10px;
        }
        .note-form input[type="text"], .note-form input[type="date"], .note-form button, .code-form select, .code-form button {
            padding: 10px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .note-form input[type="text"], .code-form select {
            width: 200px;
        }
        .note-form input[type="date"] {
            width: 150px;
        }
        .note-form button, .code-form button {
            background-color: #007bff;
            color: #ffffff;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }
        .note-form button:hover, .code-form button:hover {
            background-color: #0056b3;
        }
        .code-form select {
            width: 400px;
        }
        .success-message {
    color: green;
    display: none; /* Initially hidden */
    position: absolute; /* Positioned absolutely within the form container */
    top: 100%; /* Position below the input field */
    left: 0; /* Align to the left of the input field */
    margin-top: 0px; /* Small gap between input and message */
    white-space: nowrap; /* Prevent text wrapping */
}

.note-form, .code-form, .textarea-container {
    position: relative; 
    margin-bottom: 10px; /* Space for the success message */
    padding-bottom: 10px; /* Adjust padding to ensure space for success message */
}

.doctor-notes {
    max-height: 600px;
    overflow-y: auto;
    background-color: #f5f5f5;
    padding: 10px; /* Add padding for spacing around the container */
    border-radius: 4px;
    font-family: monospace;
    white-space: pre-wrap;
    display: flex; /* Use flexbox to handle dynamic content */
    flex-direction: column; /* Align items in a column */
    gap: 10px; /* Add gap between notes to avoid overlap */
}
.log-entry {
    margin-bottom: 5px;
    padding: 10px; /* Increase padding for better spacing */
    background-color: #e9ecef;
    border-left: 5px solid #007bff;
    clear: both; /* Ensure each entry clears previous floats */
}
.log-date {
    font-weight: bold;
    color: #007bff;
    margin-top: -30px;
    margin-bottom: -30px;
}

.log-note {
    margin: 5px 0;
    margin-bottom: -20px;
}

/* New CSS for dynamic updates */
.doctor-notes {
    display: flex;
    flex-direction: column;
    gap: 10px; /* Add spacing between notes */
}

.log-entry {
    flex-shrink: 0; /* Prevent entries from shrinking */
    width: 100%; /* Ensure log entries take full width */
    box-sizing: border-box; /* Include padding and border in the element's width and height */
}

/* Optional: Add animation for smoother appearance of new notes */
.log-entry {
    animation: fadeIn 0.5s ease-in-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}
        .textarea-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        textarea {
            font-family: monospace;
            font-size: 16px;
            color: fieldtext;
            display: inline-block;
            resize: horizontal;
            cursor: text;
            overflow-wrap: break-word;
            background-color: field;
            margin: 0em;
            border-width: 1px;
            border-style: solid;
            border-color: rgb(118, 118, 118);
            padding: 10px;
            white-space: pre-wrap;
            width: calc(100% - 100px); /* Adjust width to account for the button width */
        }
        .textarea-container button {
            background-color: #007bff;
            color: #ffffff;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            height: 40px; /* Match the height of the textarea */
            margin-left: 15px;
        }
        .textarea-container button:hover {
            background-color: #0056b3;
        }
        .add-button {
            height: 35px;
            margin-left: 15px;
        }
        h3 {
            display: block;
            font-size: 1.17em;
            margin-block-start: 1em;
            margin-block-end: 1em;
            margin-inline-start: 0px;
            margin-inline-end: 0px;
            font-weight: bold;
            unicode-bidi: isolate;
            margin-top: -18px;
            margin-bottom: -51px;
            /* position: fixed; */
        }
        .image-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* Two images per row */
            gap: 20px;
            justify-items: center;
            margin-bottom: 20px;
            margin-left: 320px; /* Add margin to prevent overlap with patient details */
            max-height: 80vh; /* Prevents the image container from overflowing the viewport */
            overflow: auto; /* Allow scrolling if there are too many images */
        }
        .image {
            position: relative;
            width: 100%;
            max-width: 275px; /* Adjusted size */
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .image:hover {
            transform: scale(1.05);
        }
        .image img {
            width: 100%;
            height: auto;
            vertical-align: middle;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            padding-top: 50px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.9);
        }
        .modal-content {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 700px;
        }
        .modal-content img {
            width: 100%;
            height: auto;
        }
        .close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="profile-card">
            <h2>Patient Details</h2>
            <p><span class="highlight">Mr_no:</span> <%= patient.Mr_no %></p>
            <p><span class="highlight">Name:</span> <%= patient.Name %></p>
            <p><span class="highlight">Date of Birth:</span> <%= patient.DOB %></p>
            <p><span class="highlight">Date and Time:</span> <%= patient.datetime %></p>
            <p><span class="highlight">Speciality:</span> <%= patient.speciality %></p>
            <p><span class="highlight">Date of Surgery:</span> <%= patient.dateOfSurgery %></p>
            <p><span class="highlight">Phone Number:</span> <%= patient.phoneNumber %></p>
        </div>
        <div class="image-container">
            <% surveyNames.forEach(function(name) { %>
                <% if (name === 'PROMIS-10') { %>
                    <div class="image">
                        <img src="new_folder/plot_physical_health_<%= patient.Mr_no %>.jpg" alt="Physical Health" onclick="openModal('new_folder/plot_physical_health_<%= patient.Mr_no %>.jpg')">
                        <img src="new_folder/plot_mental_health_<%= patient.Mr_no %>.jpg" alt="Mental Health" onclick="openModal('new_folder/plot_mental_health_<%= patient.Mr_no %>.jpg')">
                        <form onsubmit="handleGenerateGraph(event, '<%= patient.Mr_no %>', '<%= name %>')">
                            <input type="hidden" name="Mr_no" value="<%= patient.Mr_no %>">
                            <input type="hidden" name="surveyType" value="<%= name %>">
                            <button type="submit" class="survey-button">
                                <%= name %>
                            </button>
                        </form>
                    </div>
                <% } else { %>
                    <div class="image">
                        <img src="new_folder/plot_<%= name %>_<%= patient.Mr_no %>.jpg" alt="<%= name %>" onerror="this.src='new_folder/plot_EPDS_<%= patient.Mr_no %>.jpg'" onclick="openModal('new_folder/plot_<%= name %>_<%= patient.Mr_no %>.jpg')">
                        <form onsubmit="handleGenerateGraph(event, '<%= patient.Mr_no %>', '<%= name %>')">
                            <input type="hidden" name="Mr_no" value="<%= patient.Mr_no %>">
                            <input type="hidden" name="surveyType" value="<%= name %>">
                            <button type="submit" class="survey-button">
                                <%= name %>
                            </button>
                        </form>
                    </div>
                <% } %>
            <% }); %>
        </div>
        <div class="form-container">
            <div class="note-form">
                <form id="note-form" action="/addNote" method="POST" onsubmit="submitForm(event, 'note-form', 'note-message')">
                    <input type="hidden" name="Mr_no" value="<%= patient.Mr_no %>">
                    <label for="note">Intervention:</label>
                    <input type="text" id="note" name="event" placeholder="Enter your Intervention here" required>
                    <label for="date">Date:</label>
                    <input type="date" id="date" name="date" required>
                    <button type="submit" class="add-button">Add</button>
                    <span class="success-message" id="note-message">Successfully added!</span>
                </form>
            </div>
            
            <div class="code-form">
                <form id="code-form" action="/addCode" method="POST" onsubmit="submitForm(event, 'code-form', 'code-message')">
                    <input type="hidden" name="Mr_no" value="<%= patient.Mr_no %>">
                    <label for="code">ICD Code:</label>
                    <select id="code" name="code" required>
                        <option value="" disabled selected>Select a code</option>
                    </select>
                    <input type="hidden" id="code_date" name="code_date">
                    <button type="submit" class="add-button">Add</button>
                    <span class="success-message" id="code-message">Successfully added!</span>
                </form>
            </div>
            
            <div class="note-form">
                <form id="doctor-note-form" action="/addDoctorNote" method="POST" onsubmit="submitForm(event, 'doctor-note-form', 'note-doctor')">
                    <input type="hidden" name="Mr_no" value="<%= patient.Mr_no %>">
                    <label for="doctor-note">Doctor's Note:</label>
                    <div class="textarea-container">
                        <textarea id="doctor-note" name="doctorNote" placeholder="Enter doctor's note here" required></textarea>
                        <button type="submit">Add</button>
                    </div>
                    <span class="success-message" id="note-doctor">Successfully added!</span>
                </form>
            </div>
            
            <h3></h3>
            <div class="doctor-notes">
                <% if (doctorNotes.length > 0) { %>
                    <% doctorNotes.forEach(function(note) { %>
                        <div class="log-entry">
                            <div class="log-date"><%= note.date %></div>
                            <div class="log-note"><%= note.note %></div>
                        </div>
                    <% }); %>
                <% } else { %>
                    <!-- <p>No notes available</p> -->
                <% } %>
            </div>
        </div>
    </div>
    <div id="myModal" class="modal">
        <span class="close" onclick="closeModal()">&times;</span>
        <div class="modal-content">
            <img id="modalImage" src="" alt="Enlarged Image">
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        let currentPage = 1;
        const limit = 50;

        document.addEventListener("DOMContentLoaded", function() {
            $('#code').select2();
            var currentDate = new Date().toISOString().split('T')[0];
            document.getElementById("code_date").value = currentDate;
            loadCodes(currentPage, limit);
        });

        function loadCodes(page, limit) {
            $.ajax({
                url: `/codes?page=${page}&limit=${limit}`,
                method: 'GET',
                success: function(codes) {
                    const codeSelect = $('#code');
                    codes.forEach(code => {
                        codeSelect.append(new Option(code.description, code.code));
                    });
                },
                error: function() {
                    alert('An error occurred while fetching codes. Please try again.');
                }
            });
        }

        function showMessage(messageId) {
            const message = document.getElementById(messageId);
            message.style.display = 'inline';
            setTimeout(() => {
                message.style.display = 'none';
            }, 2000);
        }

        function submitForm(event, formId, messageId) {
            event.preventDefault();
            const form = document.getElementById(formId);
            const formData = $(form).serialize();

            $.ajax({
                type: "POST",
                url: form.action,
                data: formData,
                success: function(response) {
                    showMessage(messageId);
                    if (formId === 'doctor-note-form') {
                        const noteDate = new Date().toISOString().split('T')[0];
                        const noteText = document.getElementById('doctor-note').value;
                        addDoctorNoteToLog(noteDate, noteText);
                        document.getElementById('doctor-note').value = '';
                    }
                },
                error: function() {
                    alert('An error occurred. Please try again.');
                }
            });
        }

        function addDoctorNoteToLog(date, note) {
    const logContainer = document.querySelector('.doctor-notes');
    const newLogEntry = document.createElement('div');
    newLogEntry.className = 'log-entry';
    newLogEntry.innerHTML = `
        <div class="log-date">${date}</div>
        <div class="log-note">${note}</div>
    `;

    logContainer.prepend(newLogEntry); // Append new log entry at the top

    // Force a reflow to ensure the new element is displayed properly
    logContainer.style.transform = 'scale(1)';

    // Optionally, force reflow by toggling a class
    newLogEntry.classList.add('fadeIn');
    setTimeout(() => {
        newLogEntry.classList.remove('fadeIn');
    }, 500);

    // Use requestAnimationFrame for smoother updates
    requestAnimationFrame(() => {
        logContainer.scrollTop = 0; // Scroll to the top if needed
    });
}

// Add the fadeIn class for new entries
document.styleSheets[0].insertRule(`
    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }
`, document.styleSheets[0].cssRules.length);

document.styleSheets[0].insertRule(`
    .log-entry.fadeIn {
        animation: fadeIn 0.5s ease-in-out;
    }
`, document.styleSheets[0].cssRules.length);


        function openModal(imageSrc) {
            const modal = document.getElementById('myModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imageSrc;
            modal.style.display = 'block';
        }

        function closeModal() {
            const modal = document.getElementById('myModal');
            modal.style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('myModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        function handleGenerateGraph(event, mrNo, surveyType) {
            event.preventDefault();
            $.ajax({
                type: "POST",
                url: "/generateGraph",
                data: { Mr_no: mrNo, surveyType: surveyType },
                success: function(response) {
                    const port = 3003;
                    // Adjust the logic to handle specific file paths for different surveys
                    let graphUrl = `http://localhost:${port}/Doctor_Login_Page/new_folder_1/${surveyType}.html`;
                    
                    // Special case for PROMIS-10 to open both physical and mental health graphs
                    if (surveyType === 'PROMIS-10') {
                        const physicalGraphUrl = `http://localhost:${port}/Doctor_Login_Page/new_folder_1/plot_physical_health_${mrNo}.html`;
                        const mentalGraphUrl = `http://localhost:${port}/Doctor_Login_Page/new_folder_1/plot_mental_health_${mrNo}.html`;
                        window.open(physicalGraphUrl, '_blank');
                        window.open(mentalGraphUrl, '_blank');
                    } else {
                        window.open(graphUrl, '_blank');
                    }
                },
                error: function() {
                    alert('An error occurred while generating the graph. Please try again.');
                }
            });
        }
    </script>
</body>
</html>