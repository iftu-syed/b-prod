
 <!--this the code that display the all the dynamic graphs-->


 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Details</title>
    <link rel="stylesheet" href="/patientdetails.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

   
</head>

<body style="background-color: #fff;">
    <div class="sidebar">
        <div class="top">
             <div class="logo">
            <img src="/assets/logo.png" alt="WeHealthify">
             </div>
             <i class="bx bx-menu" id="btn"></i>
        </div>
    
        
        <div class="user">
            <div>
                <p class="bold">Doc Username</p>
                <p>Doc Specialty</p>
            </div>
        </div>
        <ul>
            <li>
                <a href="#">
                    <i class="bx bxs-grid-alt"></i>
                    <span class="nav-item">Dashboard</span>
                </a>
                <span class="tooltip">Dashboard</span>
            </li>
            <li>
                <a href="#">
                    <i class='bx bx-line-chart'></i>
                    <span class="nav-item">Reports</span>
                </a>
                <span class="tooltip">Reports</span>
            </li>            
            <li>
                <a href="#">
                    <i class='bx bx-group'></i>
                    <span class="nav-item">Patients</span>
                </a>
                <span class="tooltip">Patients</span>
            </li>            
            <li>
                <a href="#">
                    <i class="bx bx-spreadsheet"></i>
                    <span class="nav-item">Surveys</span>
                </a>
                <span class="tooltip">Surveys</span>
            </li>
            <li>
                <a href="/logout" class="logout-button">
                    <i class="bx bx-log-out"></i>
                    <span class="nav-item">Logout</span>
                </a>
                <span class="tooltip">Logout</span>
            </li>
        </ul>
    </div>

    <div class="main-content">
        <div class="topbar">
            <h1>Welcome, Dr. Jack</h1>

            <form action="/search" method="GET" class="searchtopbar">
                <input type="text" name="mrNo" placeholder="Quick MR Search" >
                <button type="submit" class="btn-search"><i class='bx bx-search-alt'></i></button>
              </form>
            
        </div>
        <hr class="ruledbook">

    
    

<div class="parentrow">
        <div class="parentcolumn">
            <div class="inforow">
                <div class="column">
                    <p><span class="highlight">Mr_no:</span> </p>
                    <p><span class="highlight">Name:</span></p>
                    <p><span class="highlight">Date of Birth:</span></p>
                    <p><span class="highlight">Date and Time:</span></p>
                    <p><span class="highlight">Speciality:</span></p>
                    <p><span class="highlight">Date of Surgery:</span> </p>
                    <p><span class="highlight">Phone Number:</span> </p>
                </div>

                <div class="column">
                    <p><%= patient.Mr_no %></p>
                    <p><%= patient.Name %></p>
                    <p><%= patient.DOB %></p>
                    <p><%= patient.datetime %></p>
                    <p><%= patient.speciality %></p>
                    <p><%= patient.dateOfSurgery %></p>
                    <p><%= patient.phoneNumber %></p>
                </div>
                <div class="column"> </div>
            </div>
<hr class="spacer">
<hr class="ruledbook">
<hr class="spacer">

<div class="inforow">
    <div class="column">
<a>Intervention:</a>

<a>Date:</a>

<a>ICD Code:</a>  

<a>Doctor's Note:</a>

        </div> 
    <div class="column">
    <div class="form-container">
        <div class="note-form">
            <form id="note-form" action="/addNote" method="POST" onsubmit="submitForm(event, 'note-form', 'note-message')">
                <input type="hidden" name="Mr_no" value="<%= patient.Mr_no %>">
                <input type="text" id="note" name="event" placeholder="Enter your Intervention here" required><br><br>
                <input type="date" id="date" name="date" required>
                <button type="submit" class="add-button"><i class='bx bx-plus'></i> Add</button>
                <span class="success-message" id="note-message">Successfully added!</span>
            </form>
        </div>
        
        <div class="code-form">
            <form id="code-form" action="/addCode" method="POST" onsubmit="submitForm(event, 'code-form', 'code-message')">
                <input type="hidden" name="Mr_no" value="<%= patient.Mr_no %>">
                <select id="code" name="code" required>
                    <option value="" disabled selected>Select a code</option>
                </select>
                <input type="hidden" id="code_date" name="code_date">
                <button type="submit" class="add-button"><i class='bx bx-plus'></i> Add</button>
                <span class="success-message" id="code-message">Successfully added!</span>
            </form>
        </div>
        
        <div class="note-form">
            <form id="doctor-note-form" action="/addDoctorNote" method="POST" onsubmit="submitForm(event, 'doctor-note-form', 'note-doctor')">
                <input type="hidden" name="Mr_no" value="<%= patient.Mr_no %>">
                <div class="textarea-container">
                    <textarea id="doctor-note" name="doctorNote" placeholder="Enter doctor's note here" required></textarea>
                    <button type="submit"><i class='bx bx-plus'></i> Add</button>
                </div>
                <span class="success-message" id="note-doctor">Successfully added!</span>
            </form>
        </div>

        </div>
    </div>
</div>
<h3>Doctor's Notes:</h3>
<div class="doctor-notes">
    <% if (doctorNotes.length > 0) { %>
        <% doctorNotes.forEach(function(note) { %>
            <div class="log-entry">
                <div class="log-date"><%= note.date %></div>
                <div class="log-note"><%= note.note %></div>
            </div>
        <% }); %>
    <% } else { %>
        <!-- <p>No notes available</p> -->
    <% } %>
</div>
        </div>
        <hr class="ruledbook">
        <div class="parentcolumn">
            <div class="inforow">
                
            <% surveyNames.forEach(function(name) { %>
                <% if (name === 'PROMIS-10') { %>
                    <div class="image">
                        <img src="new_folder/plot_physical_health_<%= patient.Mr_no %>.jpg" alt="Physical Health" onclick="openModal('new_folder/plot_physical_health_<%= patient.Mr_no %>.jpg')">
                        <img src="new_folder/plot_mental_health_<%= patient.Mr_no %>.jpg" alt="Mental Health" onclick="openModal('new_folder/plot_mental_health_<%= patient.Mr_no %>.jpg')">
                        <form onsubmit="handleGenerateGraph(event, '<%= patient.Mr_no %>', '<%= name %>')">
                            <input type="hidden" name="Mr_no" value="<%= patient.Mr_no %>">
                            <input type="hidden" name="surveyType" value="<%= name %>">
                            <button type="submit" class="survey-button">
                                <%= name %>
                            </button>
                        </form>
                    </div>
                <% } else { %>
                    <div class="image">
                        <img src="new_folder/plot_<%= name %>_<%= patient.Mr_no %>.jpg" alt="<%= name %>" onerror="this.src='new_folder/plot_EPDS_<%= patient.Mr_no %>.jpg'" onclick="openModal('new_folder/plot_<%= name %>_<%= patient.Mr_no %>.jpg')">
                        <form onsubmit="handleGenerateGraph(event, '<%= patient.Mr_no %>', '<%= name %>')">
                            <input type="hidden" name="Mr_no" value="<%= patient.Mr_no %>">
                            <input type="hidden" name="surveyType" value="<%= name %>">
                            <button type="submit" class="survey-button">
                                <%= name %>
                            </button>
                        </form>
                    </div>
                <% } %>
            <% }); %>
            </div>
        </div>
    <div id="myModal" class="modal">
        <span class="close" onclick="closeModal()">&times;</span>
        <div class="modal-content">
            <img id="modalImage" src="" alt="Enlarged Image">
        </div>

    </div>
    </div>

        
        
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        let currentPage = 1;
        const limit = 50;

        document.addEventListener("DOMContentLoaded", function() {
            $('#code').select2();
            var currentDate = new Date().toISOString().split('T')[0];
            document.getElementById("code_date").value = currentDate;
            loadCodes(currentPage, limit);
        });

        function loadCodes(page, limit) {
            $.ajax({
                url: `/codes?page=${page}&limit=${limit}`,
                method: 'GET',
                success: function(codes) {
                    const codeSelect = $('#code');
                    codes.forEach(code => {
                        codeSelect.append(new Option(code.description, code.code));
                    });
                },
                error: function() {
                    alert('An error occurred while fetching codes. Please try again.');
                }
            });
        }

        function showMessage(messageId) {
            const message = document.getElementById(messageId);
            message.style.display = 'inline';
            setTimeout(() => {
                message.style.display = 'none';
            }, 2000);
        }

        function submitForm(event, formId, messageId) {
            event.preventDefault();
            const form = document.getElementById(formId);
            const formData = $(form).serialize();

            $.ajax({
                type: "POST",
                url: form.action,
                data: formData,
                success: function(response) {
                    showMessage(messageId);
                    if (formId === 'doctor-note-form') {
                        const noteDate = new Date().toISOString().split('T')[0];
                        const noteText = document.getElementById('doctor-note').value;
                        addDoctorNoteToLog(noteDate, noteText);
                        document.getElementById('doctor-note').value = '';
                    }
                },
                error: function() {
                    alert('An error occurred. Please try again.');
                }
            });
        }

        function addDoctorNoteToLog(date, note) {
    const logContainer = document.querySelector('.doctor-notes');
    const newLogEntry = document.createElement('div');
    newLogEntry.className = 'log-entry';
    newLogEntry.innerHTML = `
        <div class="log-date">${date}</div>
        <div class="log-note">${note}</div>
    `;

    logContainer.prepend(newLogEntry); // Append new log entry at the top

    // Force a reflow to ensure the new element is displayed properly
    logContainer.style.transform = 'scale(1)';

    // Optionally, force reflow by toggling a class
    newLogEntry.classList.add('fadeIn');
    setTimeout(() => {
        newLogEntry.classList.remove('fadeIn');
    }, 500);

    // Use requestAnimationFrame for smoother updates
    requestAnimationFrame(() => {
        logContainer.scrollTop = 0; // Scroll to the top if needed
    });
}

// Add the fadeIn class for new entries
document.styleSheets[0].insertRule(`
    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }
`, document.styleSheets[0].cssRules.length);

document.styleSheets[0].insertRule(`
    .log-entry.fadeIn {
        animation: fadeIn 0.5s ease-in-out;
    }
`, document.styleSheets[0].cssRules.length);


        function openModal(imageSrc) {
            const modal = document.getElementById('myModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imageSrc;
            modal.style.display = 'block';
        }

        function closeModal() {
            const modal = document.getElementById('myModal');
            modal.style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('myModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        function handleGenerateGraph(event, mrNo, surveyType) {
            event.preventDefault();
            $.ajax({
                type: "POST",
                url: "/generateGraph",
                data: { Mr_no: mrNo, surveyType: surveyType },
                success: function(response) {
                    const port = 3003;
                    // Adjust the logic to handle specific file paths for different surveys
                    let graphUrl = `http://localhost:${port}/Doctor_Login_Page/new_folder_1/${surveyType}.html`;
                    
                    // Special case for PROMIS-10 to open both physical and mental health graphs
                    if (surveyType === 'PROMIS-10') {
                        const physicalGraphUrl = `http://localhost:${port}/Doctor_Login_Page/new_folder_1/plot_physical_health_${mrNo}.html`;
                        const mentalGraphUrl = `http://localhost:${port}/Doctor_Login_Page/new_folder_1/plot_mental_health_${mrNo}.html`;
                        window.open(physicalGraphUrl, '_blank');
                        window.open(mentalGraphUrl, '_blank');
                    } else {
                        window.open(graphUrl, '_blank');
                    }
                },
                error: function() {
                    alert('An error occurred while generating the graph. Please try again.');
                }
            });
        }

        let btn = document.querySelector('#btn');
    let sidebar = document.querySelector('.sidebar');

    btn.onclick = function() {
        sidebar.classList.toggle('active');
    };
    </script>
</body>
</html>