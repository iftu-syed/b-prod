<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Entry Form</title>
    <link rel="stylesheet" href="<%= basePath %>/styles.css"> <!-- Correct the path to your CSS file -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

    <style>
        /* Existing styles for .form-select */
        .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #5F677C;
            border-radius: 5px;
            appearance: none;
            font-weight: lighter;
            background-color: white; /* Ensure background is white */
            color: black; /* Ensure text color is black */
        }

        /* Ensure the dropdown options have a white background with black text */
        .form-select option {
            background-color: white; /* White background for options */
            color: black; /* Black text for options */
        }

        /* Apply styles specifically when the dropdown is expanded */
        .form-select:focus {
            background-color: white; /* White background when dropdown is focused/expanded */
            color: black; /* Black text when dropdown is focused/expanded */
        }

        /* Ensure selected option also has a white background and black text */
        .form-select option:checked {
            background-color: white; /* White background for the selected option */
            color: black; /* Black text for the selected option */
        }

        /* Additional styling for the dropdown arrow */
        .form-select .arrow {
            margin-left: 40px;
            display: inline-block;
            width: 10px;
            height: 10px;
            border-right: 2px solid #131217;
            border-top: 2px solid #131217;
            transform: rotate(45deg);
            transition: transform 0.3s ease;
        }

        .optional-text {
            font-size: smaller; /* Adjust the size as needed */
            color: gray;       /* Optional: Change color for more distinction */
        }

        .csv-upload-button {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            border-radius: 4px;
        }

        .csv-upload-button:hover {
            background-color: #0056b3;
        }

        #csvFile {
            display: none;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="top">
            <div class="logo">
                <img src="<%= basePath %>/assets/images/logo_white.png" alt="WeHealthify">
            </div>
            <i class="bx bx-menu" id="btn"></i>
        </div>
        <br>
        <div class="sidebar-footer">
            <p class="bold">Staff</p>
            <p class="bold"><%= doctor.hospitalName %></p><!-- Updated here -->
            <p class="bold"><%= doctor.site_code %></p>   <!-- Updated here -->
        </div>

        <ul>
            <li>
                <a href="<%= basePath %>/blank-page">
                    <i class="bx bxs-grid-alt"></i>
                    <span class="nav-item">Dashboard</span>
                </a>
                <span class="tooltip">Dashboard</span>
            </li>
            <li>
                <a href="<%= basePath %>/data-entry">
                    <i class='bx bx-plus-circle'></i>
                    <span class="nav-item">Add Appointment</span>
                </a>
                <span class="tooltip">Add Appointment</span>
            </li>
            <li>
                <a href="<%= basePath %>/logout">
                    <i class="bx bx-log-out"></i>
                    <span class="nav-item">Logout</span>
                </a>
                <span class="tooltip">Logout</span>
            </li>            
        </ul>
    </div>

    <div class="main-content">
        <div class="topbar">
            <!-- <h1>Add Appointment</h1>  -->
            <h2 style="color: #333333;">Welcome, <%= doctor.firstName %> <%= doctor.lastName %></h2> <!-- Updated here -->
        </div>
        <hr style="opacity: 0.5;">   

        <div class="csv-upload-container">
            <div class="main-container">
                <div class="topContainer">
                    <br><br><h2 style="text-align: center; margin-bottom: 20px; color: #333333;">Data Entry Form</h2>
                </div>
                
                <!-- image -->
                <div class="container">
                    <div class="left-section">
                        <h4>Batch Appointments</h4>
                        <form id="csvUploadForm" class="upload-area" method="POST" action="<%= basePath %>/api/upload-csv" enctype="multipart/form-data" style="position: relative;">
                            <i class='bx bx-upload' style='font-size: 60px;'></i>
                            <p><b>Select a CSV file to upload</b><br>or drag and drop it here</p>
                            <input type="file" id="csvFile" name="csvFile" accept=".csv" required>
                        </form>
                        <a href="<%= basePath %>/Data_Entry_Incoming.patient_data.csv"><span><b>Find CSV Template Here</b></span></a>
                        <div style="text-align: center;">
                            <button type="button" class="upload-btn" onclick="document.getElementById('csvFile').click()"><i class='bx bx-upload'></i> Upload CSV</button>
                        </div>
                    </div>

                    <hr>
                    <div class="middle-section">
                        <h4>Single Appointments</h4>
                        <form id="dataForm" method="POST" action="<%= basePath %>/api/data">
                            <div class="form-group">
                                <label for="Mr_no" class="form-label">MR Number</label>
                                <input type="text" id="Mr_no" class="form-input" name="Mr_no" required>
                            </div>
                            <div class="form-group">
                                <label for="firstName" class="form-label">First Name:</label>
                                <input type="text" id="firstName" class="form-input" name="firstName" required>
                            </div>
                            <div class="form-group">
                                <label for="middleName" class="form-label">Middle Name (Optional):</label>
                                <input type="text" id="middleName" class="form-input" name="middleName">
                            </div>
                            <div class="form-group">
                                <label for="lastName" class="form-label">Last Name:</label>
                                <input type="text" id="lastName" class="form-input" name="lastName" required>
                            </div>
                    </div>

                    <div class="right-section">
                        <h4> <pre> </pre></h4>
                        <div class="form-group">
                            <label for="DOB" class="form-label">Date of Birth:</label>
                            <input type="text" class="form-input" id="DOB" name="DOB" required>
                        </div>
                        <div class="form-group">
                            <label for="phoneNumber" class="form-label">Phone Number</label>
                            <input type="tel" id="phoneNumber" class="form-input" name="phoneNumber" required>
                        </div>

                        <div class="form-group">
                            <label for="datetime" class="form-label">Appointment Date & Time</label>
                            <input type="datetime-local" id="datetime" class="form-input" name="datetime" required>
                        </div>
                        <div class="form-group">
                            <label for="speciality-doctor" class="form-label">Doctor</label>
                            <select id="speciality-doctor" class="form-select" name="speciality-doctor" required>
                                <option value="">Select Doctor</option>
                                <!-- Options will be dynamically populated here -->
                            </select>
                        </div>

                        <input type="hidden" name="hospital_code" value="<%= hospital_code %>">
                        <input type="hidden" name="site_code" value="<%= site_code %>"> <!-- Add this line -->
                        <input type="hidden" name="surveyStatus" value="Not Completed"> 
                        
                        <button type="submit" class="submit-btn"><i class='bx bx-check-double'></i> Submit</button>
                    </form>
                </div>
            </div>
            <% if (successMessage) { %>
                <div class="success-message">
                    <%= successMessage %>
                </div>
            <% } %>
            <% if (errorMessage) { %>
                <div class="error-message">
                    <%= errorMessage %>
                </div>
            <% } %>            
        </div>
    </div>

    <!-- Confirmation message -->
    <div id="confirmationMessage" style="display: none;">Data Entry is done.</div>

    <!-- Include Flatpickr library -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/en.js"></script>
    <script>
        // Initialize Flatpickr for datetime with custom minute increments and 12-hour time format
        flatpickr("#datetime", {
            enableTime: true,
            dateFormat: "Y-m-d h:i K", // Store the value in 12-hour format with AM/PM
            time_24hr: false, // Use 12-hour format with AM/PM
            minuteIncrement: 15, // Set minute increments to 15 (00, 15, 30, 45)
            minDate: "today", // Disable past dates and times
            altInput: true, // Use an alternative input for displaying the formatted date
            altFormat: "F j, Y h:i K", // Display format for the alternative input (12-hour time with AM/PM)
            defaultHour: 12, // Set default hour to 12 PM
        });

        // Initialize Flatpickr for DOB with custom format
        flatpickr("#DOB", {
            dateFormat: "m/d/Y", // Store the value in MM/DD/YYYY format
            maxDate: "today", // Disable future dates
            altInput: true, // Use an alternative input for displaying the formatted date
            altFormat: "m/d/Y", // Display format for the alternative input
        });

        document.getElementById('Mr_no').addEventListener('change', function() {
            var mrNo = this.value;
            if (mrNo) {
                // Fetch patient data
                fetch(`<%= basePath %>/api/patient/${mrNo}`)
                    .then(response => response.json())
                    .then(patientData => {
                        if (patientData.success) {
                            const patient = patientData.patient;

                            // Populate the form fields with the returned data
                            document.getElementById('firstName').value = patient.firstName || '';
                            document.getElementById('middleName').value = patient.middleName || '';
                            document.getElementById('lastName').value = patient.lastName || '';

                            // Set the DOB in the input and update Flatpickr
                            const dobInput = document.getElementById('DOB');
                            dobInput.value = patient.DOB || '';
                            if (patient.DOB) {
                                flatpickr(dobInput, {
                                    dateFormat: "m/d/Y",
                                    defaultDate: patient.DOB
                                });
                            }

                            document.getElementById('phoneNumber').value = patient.phoneNumber || '';
                        } else {
                            alert('Patient not found.');
                        }
                    })
                    .catch(error => console.error('Error fetching patient data:', error));
            }
        });
    </script>
    <script>
        let btn = document.querySelector('#btn');
        let sidebar = document.querySelector('.sidebar');
        
        btn.onclick = function() {
            sidebar.classList.toggle('active');
        };
        
        // Show the loading GIF when the form is submitted
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', function() {
                document.getElementById('loadingContainer').style.display = 'flex';
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const sidebarLinks = document.querySelectorAll('.sidebar ul li a');

            function removeCurrentPageClasses() {
                sidebarLinks.forEach(link => {
                    link.classList.remove('CurrentPage');
                });
            }

            function setCurrentPageLink(path) {
                removeCurrentPageClasses();
                console.log(`Setting CurrentPage link for path: ${path}`);
                const currentPageLink = Array.from(sidebarLinks).find(link => {
                    const linkPath = new URL(link.href).pathname;
                    return linkPath === path;
                });
                if (currentPageLink) {
                    console.log(`CurrentPage link found: ${currentPageLink.href}`);
                    currentPageLink.classList.add('CurrentPage');
                } else {
                    console.log(`No CurrentPage link found for path: ${path}`);
                }
            }

            // Check the URL path and set the current page link on page load
            const currentPath = window.location.pathname;
            console.log(`Current path: ${currentPath}`);
            setCurrentPageLink(currentPath);

            sidebarLinks.forEach(link => {
                link.addEventListener('click', function() {
                    const targetPath = new URL(link.href).pathname;
                    console.log(`Navigating to: ${targetPath}`);
                    setCurrentPageLink(targetPath);
                });
            });
        });
        setTimeout(() => {
            document.querySelectorAll('.success-message, .error-message').forEach(message => {
                message.style.display = 'none';
            });
        }, 3000); // Hide the message after 3 seconds
    </script>

    <script>
        // Populate the combined dropdown on page load
        document.addEventListener('DOMContentLoaded', function() {
            const hospital_code = "<%= hospital_code %>"; // Get the hospital_code from the session
            const site_code = "<%= site_code %>"; // Get the site_code from the session
            
            // Fetch all specialities and their respective doctors
            fetch(`<%= basePath %>/api/specialties-doctors?hospital_code=${hospital_code}&site_code=${site_code}`)
                .then(response => response.json())
                .then(data => {
                    const selectElement = document.getElementById('speciality-doctor');
                    if (data.success) {
                        data.specialties.forEach(speciality => {
                            // Create an optgroup for each specialty
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = speciality.name;

                            speciality.doctors.forEach(doctor => {
                                const option = document.createElement('option');
                                option.value = `${speciality.name}||${doctor.doctor_id}`;  // Store both specialty and doctor in value
                                option.textContent = doctor.doctor_id; // Display doctor ID
                                optgroup.appendChild(option);
                            });

                            selectElement.appendChild(optgroup);
                        });
                    } else {
                        alert('No specialities or doctors found.');
                    }
                })
                .catch(error => console.error('Error fetching specialties and doctors:', error));
        });

        // On form submission, parse the selected value to extract specialty and doctor
        document.querySelector('form').addEventListener('submit', function(event) {
            const combinedValue = document.getElementById('speciality-doctor').value;
            if (combinedValue) {
                const [speciality, doctor] = combinedValue.split('||');
                
                // Append hidden fields to store extracted specialty and doctor names
                const specialityInput = document.createElement('input');
                specialityInput.type = 'hidden';
                specialityInput.name = 'speciality';
                specialityInput.value = speciality;
        
                const doctorInput = document.createElement('input');
                doctorInput.type = 'hidden';
                doctorInput.name = 'doctor';
                doctorInput.value = doctor;
        
                this.appendChild(specialityInput);
                this.appendChild(doctorInput);
            }
        });
    </script>
</body>
</html>