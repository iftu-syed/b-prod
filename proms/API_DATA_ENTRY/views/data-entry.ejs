<!-- views/data-entry.ejs -->

<!-- The EJS template includes HTML markup with EJS syntax for dynamic content -->


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Entry Form</title>
    <link rel="stylesheet" href="/styles.css"> <!-- Correct the path to your CSS file -->
</head>
<body>
    <h1>Data Entry Form</h1>
    <form id="dataForm" method="POST" action="/api/data"> <!-- Use POST method and specify action -->
        <label for="Mr_no">MR Number:</label>
        <input type="text" id="Mr_no" name="Mr_no" required><br><br>
        
        <label for="Name">Name:</label>
        <input type="text" id="Name" name="Name" required><br><br>
        
        <label for="DOB">Date of Birth:</label>
        <input type="date" id="DOB" name="DOB" required><br><br>

        <label for="datetime">Appointment Date and Time:</label>
        <input type="datetime-local" id="datetime" name="datetime" required><br><br>
        
        <label for="speciality">Speciality:</label>
        <select id="speciality" name="speciality" required>
            <option value="">Select Speciality</option>
            <% if (specialities && specialities.length > 0) { %>
                <% specialities.forEach(function(speciality) { %>
                    <option value="<%= speciality %>"><%= speciality %></option>
                <% }); %>
            <% } else { %>
                <option value="" disabled>No specialities available</option>
            <% } %>
        </select><br><br>
        
        <label for="dateOfSurgery">Date of Surgery:</label>
        <input type="date" id="dateOfSurgery" name="dateOfSurgery"><br><br>
        
        <label for="phoneNumber">Phone Number:</label>
        <input type="tel" id="phoneNumber" name="phoneNumber" required><br><br>
        
        <button type="submit">Submit</button>
    </form>
    <!-- Confirmation message -->
    <div id="confirmationMessage" style="display: none;">Data Entry is done.</div>

    <% if (typeof successMessage !== 'undefined' && successMessage !== '') { %>
        <div class="success-message">
            <%= successMessage %>
        </div>
        <script>
            setTimeout(() => {
                window.location.href = '/'; // Redirect after 3 seconds
            }, 3000);
        </script>
    <% } %>

    <!-- Include the script to handle dynamic population -->

<!-- 
    <script>
        document.getElementById('Mr_no').addEventListener('change', function() {
            var mrNo = this.value;
            if (mrNo) {
                // Fetch patient data
                fetch(`/api/patient/${mrNo}`)
                    .then(response => response.json())
                    .then(patientData => {
                        if (patientData.success) {
                            const patient = patientData.patient;
    
                            // Populate the form fields with the returned data
                            document.getElementById('Name').value = patient.Name || '';
                            document.getElementById('DOB').value = patient.DOB || '';
                            document.getElementById('datetime').value = patient.datetime || '';
                            document.getElementById('dateOfSurgery').value = patient.dateOfSurgery || '';
                            document.getElementById('phoneNumber').value = patient.phoneNumber || '';
    
                            // Fetch all available specialties
                            fetch('/api/specialties')
                                .then(response => response.json())
                                .then(specialtiesData => {
                                    if (specialtiesData.success) {
                                        const specialties = specialtiesData.specialties.filter(speciality => speciality !== 'STAFF'); // Filter out STAFF
    
                                        var specialitySelect = document.getElementById('speciality');
                                        specialitySelect.innerHTML = '';
    
                                        // Determine the most recent specialty from patient's data
                                        var lastSpeciality = patient.specialities ? patient.specialities[patient.specialities.length - 1] : '';
    
                                        // Populate the dropdown with all specialties except STAFF
                                        specialitySelect.innerHTML = specialties.map(speciality => 
                                            `<option value="${speciality}" ${speciality === lastSpeciality ? 'selected' : ''}>${speciality}</option>`
                                        ).join('');
                                    } else {
                                        alert('Could not fetch specialties.');
                                    }
                                })
                                .catch(error => console.error('Error fetching specialties:', error));
                        } else {
                            alert('Patient not found.');
                        }
                    })
                    .catch(error => console.error('Error fetching patient data:', error));
            }
        });
    </script> -->
    
    <!-- <script>
        document.getElementById('Mr_no').addEventListener('change', function() {
            var mrNo = this.value;
            if (mrNo) {
                // Fetch patient data
                fetch(`/api/patient/${mrNo}`)
                    .then(response => response.json())
                    .then(patientData => {
                        if (patientData.success) {
                            const patient = patientData.patient;
    
                            // Populate the form fields with the returned data
                            document.getElementById('Name').value = patient.Name || '';
                            document.getElementById('DOB').value = patient.DOB || '';
                            document.getElementById('datetime').value = patient.datetime || '';
                            document.getElementById('dateOfSurgery').value = patient.dateOfSurgery || '';
                            document.getElementById('phoneNumber').value = patient.phoneNumber || '';
    
                            // Fetch all available specialties
                            fetch('/api/specialties')
                                .then(response => response.json())
                                .then(specialtiesData => {
                                    if (specialtiesData.success) {
                                        const specialties = specialtiesData.specialties.filter(speciality => speciality !== 'STAFF'); // Filter out STAFF
    
                                        var specialitySelect = document.getElementById('speciality');
                                        specialitySelect.innerHTML = '';
    
                                        // Determine the most recent specialty from patient's data
                                        var lastSpeciality = patient.specialities && patient.specialities.length > 0
                                            ? patient.specialities[patient.specialities.length - 1].name
                                            : '';
    
                                        // Populate the dropdown with all specialties except STAFF
                                        specialitySelect.innerHTML = specialties.map(speciality => 
                                            `<option value="${speciality}" ${speciality === lastSpeciality ? 'selected' : ''}>${speciality}</option>`
                                        ).join('');
                                    } else {
                                        alert('Could not fetch specialties.');
                                    }
                                })
                                .catch(error => console.error('Error fetching specialties:', error));
                        } else {
                            alert('Patient not found.');
                        }
                    })
                    .catch(error => console.error('Error fetching patient data:', error));
            }
        });
    </script> -->
    
    <script>
        document.getElementById('Mr_no').addEventListener('change', function() {
            var mrNo = this.value;
            if (mrNo) {
                // Fetch patient data
                fetch(`/api/patient/${mrNo}`)
                    .then(response => response.json())
                    .then(patientData => {
                        if (patientData.success) {
                            const patient = patientData.patient;
    
                            // Populate the form fields with the returned data
                            document.getElementById('Name').value = patient.Name || '';
                            document.getElementById('DOB').value = patient.DOB || '';
                            document.getElementById('datetime').value = patient.datetime || '';
                            document.getElementById('dateOfSurgery').value = patient.dateOfSurgery || '';
                            document.getElementById('phoneNumber').value = patient.phoneNumber || '';
    
                            // Fetch all available specialties
                            fetch('/api/specialties')
                                .then(response => response.json())
                                .then(specialtiesData => {
                                    if (specialtiesData.success) {
                                        // Filter out STAFF
                                        const specialties = specialtiesData.specialties.filter(speciality => speciality !== 'STAFF');
    
                                        var specialitySelect = document.getElementById('speciality');
                                        specialitySelect.innerHTML = '';
    
                                        // Find the specialty with the most recent timestamp
                                        let lastSpeciality = '';
                                        if (patient.specialities && patient.specialities.length > 0) {
                                            // Sort specialties by timestamp in descending order and take the most recent one
                                            lastSpeciality = patient.specialities
                                                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0].name;
                                        }
    
                                        // Populate the dropdown with all specialties except STAFF
                                        specialitySelect.innerHTML = specialties.map(speciality => 
                                            `<option value="${speciality}" ${speciality === lastSpeciality ? 'selected' : ''}>${speciality}</option>`
                                        ).join('');
                                    } else {
                                        alert('Could not fetch specialties.');
                                    }
                                })
                                .catch(error => console.error('Error fetching specialties:', error));
                        } else {
                            alert('Patient not found.');
                        }
                    })
                    .catch(error => console.error('Error fetching patient data:', error));
            }
        });
    </script>
    
    
    
</body>
</html>
